[TOC]



### 一  系统是如何和MySQL打交道的？

#### 1  业务系统和MySQL交互架构

我们如果要在Java系统中去访问一个MySQL数据库，必须得在系统的依赖中加入一个MySQL驱动，有了这个MySQL驱动才能跟MySQL数据库建立连接，然后执行各种各样的SQL语句。

那么这个MySQL驱动到底是个什么东西？

我们先来看下面的一段maven配置，这段maven配置中就引入了一个MySQL驱动。这里的`mysql-connector-java`就是面向Java语言的MySQL驱动：

````java
	<dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.21</version>
	</dependency>
````

如果我们要访问数据库，必须得跟数据库建立一个网络连接，那么这个连接就是由MySQL驱动建立的，他会在底层跟数据库建立网络连接，接着才能去发送请求给数据库服务器！我们看下图：

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102202832030.png?token=ACGZFEAQHWD2DSVLZ7GKDP27T753E" alt="image-20201102202832030" style="zoom: 33%;" />

当我们跟数据库之间有了网络连接之后，我们的Java代码才能基于这个连接去执行各种各样的增删改查SQL语句，我们看下图

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102203009259.png?token=ACGZFEGOPRUEMQO665OTCJC7T76BE" alt="image-20201102203009259" style="zoom:33%;" />

假设我们用Java开发了一个Web系统，是部署在Tomcat中的，那么Tomcat本身是有多个线程来并发的处理同时接收到的多个请求的，这个时候，如果Tomcat中的多个线程并发处理多个请求的时候，都要去抢夺一个连接去访问数据库的话，那效率肯定是很低下的。

另外如果Tomcat中的每个线程在每次访问数据库的时候，都基于MySQL驱动去创建一个数据库连接，然后执行SQL语句，然后执行完之后再销毁这个数据库连接，这样可能Tomcat中上百个线程会并发的频繁创建数据库连接，执行SQL语句，然后频繁的销毁数据库连接。因为每次建立一个数据库连接都很耗时，因此这样做的话效率是很低下的！

所以一般我们必须要使用一个`**数据库连接池**`，也就是说在一个池子里维持多个数据库连接，让多个线程使用里面的不同的数据库连接去执行SQL语句，然后执行完SQL语句之后，不要销毁这个数据库连接，而是把连接放回池子里，后续还可以继续使用。

基于这样的一个数据库连接池的机制，就可以解决多个线程并发的使用多个数据库连接去执行SQL语句的问题，而且还避免了数据库连接使用完之后就销毁的问题：

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102203555207.png?token=ACGZFED6CMUIABAWX3K3F27T76WY" alt="image-20201102203555207" style="zoom:33%;" />

现在我们已经知道，我们任何一个系统都会有一个数据库连接池去访问数据库，也就是说这个系统会有多个数据库连接，供多线程并发的使用。同时我们可能会有多个系统同时去访问一个数据库，这都是有可能的。

所以当我们把目光转移到MySQL的时候，我们要来思考一个问题，那就是肯定会有很多系统要与MySQL数据库建立很多个连接，那么MySQL也必然要维护与系统之间的多个连接，所以**MySQL架构体系中的第一个环节，就是连接池**。

实际上MySQL中的连接池就是维护了与系统之间的多个数据库连接。除此之外，你的系统每次跟MySQL建立连接的时候，还会根据你传递过来的账号和密码，进行账号密码的验证，库表权限的验证。

因此业务系统和MySQL系统之间的交互方式就如图所示：

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102203810549.png?token=ACGZFECD3GY5AXMJELJR3PS7T767E" alt="image-20201102203810549" style="zoom:50%;" />

#### 2  为了执行SQL语句，你知道MySQL用了什么样的架构设计吗

当我们的系统只要能从数据库连接池获取到一个数据库连接之后，我们就可以执行增删改查的SQL语句了，即我们可以通过数据库连接把要执行的SQL语句发送给MySQL数据库。

网络连接必须得分配给一个`线程`去进行处理，由一个线程来监听请求以及读取请求数据，比如从网络连接中读取和解析出来一条业务系统发送过去的SQL语句，如下图所示：

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102204558083.png" style="zoom: 33%;" />

MySQL内部提供了一个组件，就是`SQL接口（SQL Interface）`，他是一套执行SQL语句的接口，专门用于执行我们发送给MySQL的那些增删改查的SQL语句。因此，当MySQL内部的工作线程从一个网络连接中读取出来一个SQL语句之后，就会转交给SQL接口去执行，如下图。

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102204829415.png" alt="image-20201102204829415" style="zoom:33%;" />

接下来，MySQL会通过 **查询解析器** 将通过SQL接口传过来的SQL语句解析成MySQL可以理解的语句，

比如我们来举一个例子，现在我们有这么一个SQL语句：

````sql
select id,name,age from users where id=1;
````

这个查询解析器（Parser）就是负责对SQL语句进行解析的，比如对上面那个SQL语句进行一下拆解，拆解成以下几个部分：

我们现在要从“users”表里查询数据查询“id”字段的值等于1的那行数据，对查出来的那行数据要提取里面的“id,name,age”三个字段。

所谓的SQL解析，就是按照既定的SQL语法，对我们按照SQL语法规则编写的SQL语句进行解析，然后理解这个SQL语句要干什么事情，如下图所示：

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102205217444.png" alt="image-20201102205217444" style="zoom:33%;" />

当我们通过解析器理解了SQL语句要干什么之后，接着会找`查询优化器（Optimizer）`来选择一个最优的查询路径。

还是以刚才的例子，可能会解析出两个查询路径：

1. 直接定位到“users”表中的“id”字段等于1的一行数据，然后查出来那行数据的“id,name,age”三个字段的值

2. 先把“users”表中的每一行数据的“id,name,age”三个字段的值都查出来，然后从这批数据里过滤出来“id”字段等于1的那行数据的“id,name,age”三个字段

上面这就是一个最简单的SQL语句的两种实现路径，其实我们会发现，要完成这个SQL语句的目标，两个路径都可以做到，但是显然第一种查询路径更好一些。

所以查询优化器大就是会针对你编写的复杂SQL语句生成查询路径树，然后从里面选择一条最优的查询路径出来。

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102205553759.png?token=ACGZFEF45QUPAHW254CUTHK7UABBW" alt="image-20201102205553759" style="zoom:33%;" />

接着，就是把查询优化器选择的最优查询路径，也就是应该按照一个什么样的顺序和步骤去执行这个SQL语句的执行计划，把这个执行计划交给底层的存储引擎去真正的执行。所以对数据库而言，我们的数据要不然是放在内存里，要不然是放在磁盘文件里，那么现在问题来了，我们已经知道一个SQL语句要如何执行了，但是我们现在怎么知道哪些数据在内存里？哪些数据在磁盘里？我们执行的时候是更新内存的数据？还是更新磁盘的数据？我们如果更新磁盘的数据，是先查询哪个磁盘文件，再更新哪个磁盘文件？

这个时候就需要存储引擎了，存储引擎其实就是执行SQL语句的，他会按照一定的步骤去查询内存缓存数据，更新磁盘数据，查询磁盘数据，等等，执行诸如此类的一系列的操作，如下图所示。

<img src="http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102210007448.png" alt="image-20201102210007448" style="zoom:33%;" />

存储引擎可以帮助我们去访问内存以及磁盘上的数据，其实是通过执行器调用存储引擎的接口的。

执行器会根据优化器选择的执行方案，按照一定的顺序和步骤去调用存储引擎的接口，就把SQL语句的逻辑给执行了。

举个例子，比如执行器可能会先调用存储引擎的一个接口，去获取“users”表中的第一行数据，然后判断一下这个数据的“id”字段的值是否等于我们期望的一个值，如果不是的话，那就继续调用存储引擎的接口，去获取“users”表的下一行数据。

就是基于上述的思路，**执行器就会去根据我们的优化器生成的一套执行计划，然后不停的调用存储引擎的各种接口去完成SQL语句的执行计划**，大致就是不停的更新或者提取一些数据出来。

因此整个业务系统和MySQL系统交互的架构就如下图所示：

![image-20201102210306616](http://raw.githubusercontent.com/yuejuntao/typoraImg/master/img/image-20201102210306616.png)

